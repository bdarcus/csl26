/*
SPDX-License-Identifier: MPL-2.0
SPDX-FileCopyrightText: © 2023-2026 Bruce D'Arcus
*/

//! Auto-generated tests from CSL Test Suite - Native CSLN Mode
//! Do not edit manually. generated by tests/fixtures/update_disambiguation_tests.py --mode processor

use csl_legacy::csl_json::Reference as LegacyReference;
use csln_core::{
    citation::{Citation, CitationItem, CitationMode},
    Style, StyleInfo,
};
use csln_processor::{reference::Reference, Processor};
use std::collections::HashMap;

// --- Helper Functions for Native Mode ---

fn run_test_case_native(input: &str, citation_items_json: &str, expected: &str, mode: &str) {
    // Create a minimal test style
    // This demonstrates native CSLN structures without XML parsing
    let style = create_test_style();

    // Parse Input Items
    let legacy_items: Vec<LegacyReference> =
        serde_json::from_str(input).expect("Failed to parse input items");
    let mut bibliography = indexmap::IndexMap::new();
    for item in legacy_items {
        bibliography.insert(item.id.clone(), Reference::from(item));
    }

    let processor = Processor::new(style, bibliography);

    if mode == "citation" {
        let citation_batches: Vec<Vec<HashMap<String, serde_json::Value>>> =
            serde_json::from_str(citation_items_json).expect("Failed to parse citation items");

        let mut results = Vec::new();

        for batch in citation_batches {
            let items: Vec<CitationItem> = batch
                .into_iter()
                .map(|obj| CitationItem {
                    id: obj.get("id").unwrap().as_str().unwrap().to_string(),
                    ..Default::default()
                })
                .collect();

            let citation = Citation {
                items,
                mode: CitationMode::NonIntegral,
                ..Default::default()
            };

            let res = processor
                .process_citation(&citation)
                .expect("Failed to process citation");
            results.push(res);
        }

        let actual = results.join("\n");
        println!("Expected: '{}'", expected);
        println!("Actual: '{}'", actual);
        assert_eq!(actual.trim(), expected.trim(), "Citation output mismatch");
    } else if mode == "bibliography" {
        if !citation_items_json.trim().is_empty() && citation_items_json != "[]" {
            let citation_batches: Vec<Vec<HashMap<String, serde_json::Value>>> =
                serde_json::from_str(citation_items_json).unwrap_or_default();
            for batch in citation_batches {
                let items: Vec<CitationItem> = batch
                    .into_iter()
                    .map(|obj| CitationItem {
                        id: obj.get("id").unwrap().as_str().unwrap().to_string(),
                        ..Default::default()
                    })
                    .collect();
                let citation = Citation {
                    items,
                    ..Default::default()
                };
                processor.process_citation(&citation).ok();
            }
        }

        let actual = processor.render_bibliography();
        assert_eq!(
            actual.trim(),
            expected.trim(),
            "Bibliography output mismatch"
        );
    }
}

fn create_test_style() -> Style {
    // Minimal style structure for native testing
    // This will be populated per test with appropriate templates
    Style {
        info: StyleInfo {
            title: Some("Test Style".to_string()),
            id: Some("http://example.com/test".to_string()),
            ..Default::default()
        },
        ..Default::default()
    }
}

#[test]
#[ignore]
fn test_disambiguate_yearsuffixandsort_native() {
    let input = r####"[{"author": [{"family": "Asthma", "given": "Albert"}, {"family": "Bronchitis", "given": "Bosworth"}, {"family": "Cold", "given": "Crispin"}, {"family": "Dropsy", "given": "David"}, {"family": "Ebola", "given": "Elvin"}, {"family": "Fever", "given": "Fergus"}], "id": "ambigs-1", "issued": {"date-parts": [[1990]]}, "title": "Book M", "type": "book"}, {"author": [{"family": "Asthma", "given": "Albert"}, {"family": "Bronchitis", "given": "Bosworth"}, {"family": "Cold", "given": "Crispin"}, {"family": "Dropsy", "given": "David"}, {"family": "Enteritis", "given": "Ernie"}, {"family": "Fever", "given": "Fergus"}], "id": "ambigs-2", "issued": {"date-parts": [[1990]]}, "title": "Book L", "type": "book"}, {"author": [{"family": "Asthma", "given": "Albert"}, {"family": "Bronchitis", "given": "Bosworth"}, {"family": "Cold", "given": "Crispin"}, {"family": "Dropsy", "given": "David"}, {"family": "Ebola", "given": "Elvin"}, {"family": "Fever", "given": "Fergus"}], "id": "ambigs-3", "issued": {"date-parts": [[1990]]}, "title": "Book K", "type": "book"}, {"author": [{"family": "Asthma", "given": "Albert"}, {"family": "Bronchitis", "given": "Bosworth"}, {"family": "Cold", "given": "Crispin"}], "id": "ambigs-4", "issued": {"date-parts": [[1990]]}, "title": "Book J", "type": "book"}, {"author": [{"family": "Asthma", "given": "Albert"}, {"family": "Bronchitis", "given": "Beauregarde"}, {"family": "Cold", "given": "Crispin"}], "id": "ambigs-5", "issued": {"date-parts": [[1990]]}, "title": "Book I", "type": "book"}, {"author": [{"family": "Asthma", "given": "Alan"}, {"family": "Bronchitis", "given": "Bosworth"}, {"family": "Cold", "given": "Crispin"}, {"family": "Dropsy", "given": "David"}, {"family": "Ebola", "given": "Elvin"}, {"family": "Fever", "given": "Fergus"}], "id": "ambigs-6", "issued": {"date-parts": [[1990]]}, "title": "Book H", "type": "book"}, {"author": [{"family": "Doe", "given": "John"}, {"family": "Roe", "given": "Janet"}], "id": "ambigs-7", "issued": {"date-parts": [[1990]]}, "title": "Book G", "type": "book"}, {"author": [{"family": "Doe", "given": "John"}, {"family": "Roe", "given": "Jane"}], "id": "ambigs-8", "issued": {"date-parts": [[1990]]}, "title": "Book F", "type": "book"}, {"author": [{"family": "Doe", "given": "John"}, {"family": "Roe", "given": "Jane"}], "id": "ambigs-9", "issued": {"date-parts": [[1990]]}, "title": "Book E", "type": "book"}, {"author": [{"family": "Doe", "given": "John"}, {"family": "Roe", "given": "Janet"}], "id": "ambigs-10", "issued": {"date-parts": [[1990]]}, "title": "Book D", "type": "book"}, {"author": [{"family": "Doe", "given": "John"}, {"family": "Roe", "given": "Jane"}, {"family": "Jones", "given": "Robert"}], "id": "ambigs-11", "issued": {"date-parts": [[1990]]}, "title": "Book C", "type": "book"}, {"author": [{"family": "Doe", "given": "John"}, {"family": "Roe", "given": "Josephine"}, {"family": "Jones", "given": "Robert"}], "id": "ambigs-12", "issued": {"date-parts": [[1990]]}, "title": "Book B", "type": "book"}, {"author": [{"family": "Doe", "given": "John"}, {"family": "Roe", "given": "Jane"}, {"family": "Jones", "given": "Richard"}], "id": "ambigs-13", "issued": {"date-parts": [[1990]]}, "title": "Book A", "type": "book"}]"####;
    let citation_items = r####"[[{"id": "ambigs-1"}, {"id": "ambigs-2"}, {"id": "ambigs-3"}, {"id": "ambigs-4"}, {"id": "ambigs-5"}, {"id": "ambigs-6"}, {"id": "ambigs-7"}, {"id": "ambigs-8"}, {"id": "ambigs-9"}, {"id": "ambigs-10"}, {"id": "ambigs-11"}, {"id": "ambigs-12"}, {"id": "ambigs-13"}]]"####;
    let expected = r####"1990m!; 1990l!; 1990k!; 1990j!; 1990i!; 1990h!; 1990g!; 1990f!; 1990e!; 1990d!; 1990c!; 1990b!; 1990a!"####;
    let mode = "citation";

    run_test_case_native(input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_yearsuffixattwolevels_native() {
    let input = r####"[]"####;
    let citation_items = r####"[]"####;
    let expected = r####""####;
    let mode = "citation";

    run_test_case_native(input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_yearsuffixmixeddates_native() {
    let input = r####"[{"author": [{"family": "Ylinen", "given": "A"}], "id": 22, "issued": {"date-parts": [[1995]]}, "type": "article-journal"}, {"author": [{"family": "Ylinen", "given": "A"}], "id": 21, "issued": {"date-parts": [[1995]]}, "type": "article-journal"}, {"author": [{"family": "Ylinen", "given": "A"}], "id": 23, "issued": {"date-parts": [[1995]]}, "type": "article-journal"}]"####;
    let citation_items = r####"[]"####;
    let expected = r####"(A Ylinen, 1995a; b; c)"####;
    let mode = "citation";

    run_test_case_native(input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_bycitetwoauthorssamefamilyname_native() {
    let input = r####"[{"author": [{"family": "Asthma", "given": "Albert"}, {"family": "Asthma", "given": "Bridget"}], "id": "ITEM-1", "issued": {"date-parts": [[1980]]}, "title": "Book A", "type": "book"}, {"author": [{"family": "Bronchitis", "given": "Beauregarde"}], "id": "ITEM-2", "issued": {"date-parts": [[1995]]}, "title": "Book B", "type": "book"}, {"author": [{"family": "Asthma", "given": "Albert"}], "id": "ITEM-3", "issued": {"date-parts": [[1885]]}, "title": "Book C", "type": "book"}]"####;
    let citation_items = r####"[]"####;
    let expected = r####"Asthma and Asthma (1980); Bronchitis (1995); Asthma (1885)"####;
    let mode = "citation";

    run_test_case_native(input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_addnamessuccess_native() {
    let input = r####"[{"author": [{"family": "Smith", "given": "John"}, {"family": "Brown", "given": "John"}, {"family": "Jones", "given": "John"}], "id": "ITEM-1", "issued": {"date-parts": [[1980]]}, "type": "book"}, {"author": [{"family": "Smith", "given": "John"}, {"family": "Beefheart", "given": "Captain"}, {"family": "Jones", "given": "John"}], "id": "ITEM-2", "issued": {"date-parts": [[1980]]}, "type": "book"}]"####;
    let citation_items = r####"[]"####;
    let expected = r####"Smith, Brown, et al. (1980); Smith, Beefheart, et al. (1980)"####;
    let mode = "citation";

    run_test_case_native(input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_addnamesfailure_native() {
    let input = r####"[{"author": [{"family": "Smith", "given": "John"}, {"family": "Brown", "given": "John"}, {"family": "Jones", "given": "John"}], "id": "ITEM-1", "issued": {"date-parts": [[1980]]}, "type": "book"}, {"author": [{"family": "Smith", "given": "John"}, {"family": "Brown", "given": "John"}, {"family": "Jones", "given": "John"}], "id": "ITEM-2", "issued": {"date-parts": [[1980]]}, "type": "book"}]"####;
    let citation_items = r####"[]"####;
    let expected = r####"Smith et al. (1980); Smith et al. (1980)"####;
    let mode = "citation";

    run_test_case_native(input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_bycitegivennameshortforminitializewith_native() {
    let input = r####"[{"author": [{"family": "Roe", "given": "Jane"}], "id": "ITEM-1", "type": "book"}, {"author": [{"family": "Doe", "given": "John"}], "id": "ITEM-2", "type": "book"}, {"author": [{"family": "Doe", "given": "Aloysius"}], "id": "ITEM-3", "type": "book"}, {"author": [{"family": "Smith", "given": "Thomas"}], "id": "ITEM-4", "type": "book"}, {"author": [{"family": "Smith", "given": "Ted"}], "id": "ITEM-5", "type": "book"}]"####;
    let citation_items = r####"[[{"id": "ITEM-1"}], [{"id": "ITEM-2"}, {"id": "ITEM-3"}], [{"id": "ITEM-4"}, {"id": "ITEM-5"}]]"####;
    let expected = r####"Roe
J Doe; A Doe
Thomas Smith; Ted Smith"####;
    let mode = "citation";

    run_test_case_native(input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_basedonetalsubsequent_native() {
    let input = r####"[{"author": [{"family": "Baur", "given": "Bruno"}, {"family": "Fr\u00f6berg", "given": "Lars"}, {"family": "Baur", "given": "Anette"}, {"family": "Guggenheim", "given": "Richard"}, {"family": "Haase", "given": "Martin"}], "container-title": "Nordic Journal of Botany", "id": "ITEM-1", "issued": {"date-parts": [[2000]]}, "page": "119-128", "title": "Ultrastructure of snail grazing damage to calcicolous lichens", "type": "article-journal", "volume": "20"}, {"author": [{"family": "Baur", "given": "Bruno"}, {"family": "Schileyko", "given": "Anatoly A."}, {"family": "Baur", "given": "Anette"}], "container-title": "Journal of Molluscan Studies", "id": "ITEM-2", "issued": {"date-parts": [[2000]]}, "page": "285-289", "title": "Ecological observations on _Arianta aethiops aethiops_ (Helicidae), a land snail endemic to the South Carpathian mountains, Romania", "type": "article-journal", "volume": "66"}, {"author": [{"family": "Doe", "given": "John"}], "container-title": "Journal of Irreproducible Results", "id": "ITEM-3", "issued": {"date-parts": [[2000]]}, "page": "5-7", "title": "Some bogus title", "type": "article-journal", "volume": "666"}]"####;
    let citation_items = r####"[]"####;
    let expected = r####"(Baur, Fröberg, Baur, et al. 2000<i>a</i>; Baur, Schileyko &#38; Baur 2000<i>b</i>; Doe 2000)"####;
    let mode = "citation";

    run_test_case_native(input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_bycitedisambiguatecondition_native() {
    let input = r####"[{"author": [{"family": "Doe", "given": "John"}, {"family": "Roe", "given": "Jane"}], "id": "ITEM-1", "issued": {"date-parts": [[2000]]}, "title": "Book A", "type": "book"}, {"author": [{"family": "Doe", "given": "John"}, {"family": "Roe", "given": "Jane"}], "id": "ITEM-2", "issued": {"date-parts": [[2000]]}, "title": "Book B", "type": "book"}]"####;
    let citation_items = r####"[]"####;
    let expected = r####"Doe et al., <i>Book A</i> (2000); Doe et al., <i>Book B</i> (2000)"####;
    let mode = "citation";

    run_test_case_native(input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_failwithyearsuffix_native() {
    let input = r####"[]"####;
    let citation_items = r####"[]"####;
    let expected = r####""####;
    let mode = "citation";

    run_test_case_native(input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_yearsuffixfiftytwoentries_native() {
    let input = r####"[{"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-1"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-2"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-3"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-4"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-5"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-6"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-7"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-8"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-9"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-10"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-11"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-12"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-13"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-14"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-15"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-16"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-17"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-18"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-19"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-20"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-21"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-22"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-23"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-24"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-25"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-26"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-27"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-28"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-29"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-30"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-31"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-32"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-33"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-34"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-35"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-36"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-37"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-38"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-39"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-40"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-41"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-42"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-43"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-44"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-45"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-46"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-47"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-48"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-49"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-50"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-51"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-52"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-53"}]"####;
    let citation_items = r####"[]"####;
    let expected = r####"..[0] (Smith 1986a; Smith 1986b; Smith 1986c; Smith 1986d; Smith 1986e; Smith 1986f; Smith 1986g; Smith 1986h; Smith 1986i; Smith 1986j; Smith 1986k; Smith 1986l; Smith 1986m; Smith 1986n; Smith 1986o; Smith 1986p; Smith 1986q; Smith 1986r; Smith 1986s; Smith 1986t; Smith 1986u; Smith 1986v; Smith 1986w; Smith 1986x; Smith 1986y; Smith 1986z; Smith 1986aa; Smith 1986ab; Smith 1986ac; Smith 1986ad; Smith 1986ae; Smith 1986af; Smith 1986ag; Smith 1986ah; Smith 1986ai; Smith 1986aj; Smith 1986ak; Smith 1986al; Smith 1986am; Smith 1986an; Smith 1986ao; Smith 1986ap; Smith 1986aq; Smith 1986ar; Smith 1986as; Smith 1986at; Smith 1986au; Smith 1986av; Smith 1986aw; Smith 1986ax; Smith 1986ay)
>>[1] (Smith 1986az)"####;
    let mode = "citation";

    run_test_case_native(input, citation_items, expected, mode);
}
