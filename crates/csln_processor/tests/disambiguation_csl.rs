/*
SPDX-License-Identifier: MPL-2.0
SPDX-FileCopyrightText: © 2023-2026 Bruce D'Arcus
*/

//! Auto-generated tests from CSL Test Suite
//! Do not edit manually. generated by tests/fixtures/update_disambiguation_tests.py

use csl_legacy::parser::parse_style;
use csln_core::{
    BibliographySpec, CitationSpec, Style, StyleInfo,
    options::Processing,
    citation::{Citation, CitationItem, CitationMode},
};
use csln_migrate::{
    analysis, Compressor, MacroInliner, OptionsExtractor,
    TemplateCompiler, Upsampler,
};
use csln_processor::{Processor, reference::Reference};
use csl_legacy::csl_json::Reference as LegacyReference;
use roxmltree::Document;
use std::collections::HashMap;

// --- Helper Functions copied/adapted from csln_migrate/src/main.rs ---

fn compile_style_from_xml(xml: &str) -> Style {
    let doc = Document::parse(xml).expect("Failed to parse XML");
    let legacy_style = parse_style(doc.root_element()).expect("Failed to parse legacy style");
    let options = OptionsExtractor::extract(&legacy_style);
    
    // We don't track provenance in tests usually, simplifying
    
    // --- Pipeline ---
    // 1. Deconstruction
    let inliner = MacroInliner::new(&legacy_style);
    
    let flattened_bib = inliner.inline_bibliography(&legacy_style).unwrap_or_default();
    let flattened_cit = inliner.inline_citation(&legacy_style);

    // 2. Semantic Upsampling
    let mut upsampler = Upsampler::new();

    upsampler.et_al_min = legacy_style.citation.et_al_min;
    upsampler.et_al_use_first = legacy_style.citation.et_al_use_first;
    let raw_cit = upsampler.upsample_nodes(&flattened_cit);

    if let Some(ref bib) = legacy_style.bibliography {
        upsampler.et_al_min = bib.et_al_min;
        upsampler.et_al_use_first = bib.et_al_use_first;
    }
    let raw_bib = upsampler.upsample_nodes(&flattened_bib);

    // 3. Compression
    let compressor = Compressor;
    let csln_bib = compressor.compress_nodes(raw_bib);
    let csln_cit = compressor.compress_nodes(raw_cit);

    // 4. Compilation
    let template_compiler = TemplateCompiler;
    let is_numeric = matches!(options.processing, Some(Processing::Numeric));
    
    let (mut new_bib, type_templates) = template_compiler.compile_bibliography_with_types(&csln_bib, is_numeric);
    let new_cit = template_compiler.compile_citation(&csln_cit);

    // Legacy fixups (simplified from main.rs)
     let author_suffix = if let Some(ref bib) = legacy_style.bibliography {
        analysis::bibliography::extract_author_suffix(&bib.layout)
    } else {
        None
    };
    analysis::bibliography::apply_author_suffix(&mut new_bib, author_suffix);

    let bib_and = analysis::bibliography::extract_bibliography_and(&legacy_style);
    analysis::bibliography::apply_bibliography_and(&mut new_bib, bib_and);

    // 5. Build Style
    let (wrap, prefix, suffix) = analysis::citation::infer_citation_wrapping(&legacy_style.citation.layout);

    Style {
        info: StyleInfo {
            title: Some(legacy_style.info.title.clone()),
            id: Some(legacy_style.info.id.clone()),
            default_locale: legacy_style.default_locale.clone(),
            ..Default::default()
        },
        templates: None,
        options: Some(options.clone()),
        citation: Some(CitationSpec {
            template: Some(new_cit),
            wrap,
            prefix,
            suffix,
            delimiter: analysis::citation::extract_citation_delimiter(
                &legacy_style.citation.layout,
                &legacy_style.macros,
            ),
            multi_cite_delimiter: legacy_style.citation.layout.delimiter.clone(),
            ..Default::default()
        }),
        bibliography: Some(BibliographySpec {
            template: Some(new_bib),
            type_templates: if type_templates.is_empty() { None } else { Some(type_templates) },
            ..Default::default()
        }),
        ..Default::default()
    }
}

fn run_test_case(csl: &str, input: &str, citation_items_json: &str, expected: &str, mode: &str) {
    let style = compile_style_from_xml(csl);
    
    // Parse Input Items
    let legacy_items: Vec<LegacyReference> = serde_json::from_str(input).expect("Failed to parse input items");
    let mut bibliography = indexmap::IndexMap::new();
    for item in legacy_items {
        bibliography.insert(item.id.clone(), Reference::from(item));
    }
    
    let processor = Processor::new(style, bibliography);
    
    // Debug: Check bibliography
    println!("Loaded {} bibliography items", processor.bibliography.len());
    // println!("Bibliography keys: {:?}", processor.bibliography.keys());

    if mode == "citation" {
        
        let citation_batches: Vec<Vec<HashMap<String, serde_json::Value>>> = 
            serde_json::from_str(citation_items_json).expect("Failed to parse citation items");
            
        let mut results = Vec::new();
        
        for batch in citation_batches {
            let items: Vec<CitationItem> = batch.into_iter().map(|obj| {
                CitationItem {
                    id: obj.get("id").unwrap().as_str().unwrap().to_string(),
                    ..Default::default()
                }
            }).collect();
            
            // Debug: Check citation items
            // println!("Processing citation items: {:?}", items.iter().map(|i| &i.id).collect::<Vec<_>>());
            
            let citation = Citation {
                items,
                mode: CitationMode::NonIntegral,
                ..Default::default()
            };
            
            let res = processor.process_citation(&citation).expect("Failed to process citation");
            results.push(res);
        }
        
        let actual = results.join("\n"); 
        println!("Expected: '{}'", expected);
        println!("Actual: '{}'", actual);
        assert_eq!(actual.trim(), expected.trim(), "Citation output mismatch");

    } else if mode == "bibliography" {
        // Need to register citations first?
        // Usually bibliography tests assume all items in INPUT are cited.
        // But some tests might specify CITATION-ITEMS to explicitly cite a subset.
        // If CITATION-ITEMS is present, we cite them first.
        
        if !citation_items_json.trim().is_empty() && citation_items_json != "[]" {
             let citation_batches: Vec<Vec<HashMap<String, serde_json::Value>>> = 
                serde_json::from_str(citation_items_json).unwrap_or_default();
             for batch in citation_batches {
                let items: Vec<CitationItem> = batch.into_iter().map(|obj| {
                    CitationItem {
                        id: obj.get("id").unwrap().as_str().unwrap().to_string(),
                        ..Default::default()
                    }
                }).collect();
                 let citation = Citation { items, ..Default::default() };
                 processor.process_citation(&citation).ok();
             }
        } else {
             // If no citations specified, cite everything?
             // Actually CSL test suite usually implies citing everything if testing bibliography unless specified.
             // But let's assume valid tests have citation-items if they need them.
        }

        let actual = processor.render_bibliography();
        // CSL test suite output for bibliography often contains HTML tags like <div class="csl-entry">...</div>
        // And usually double newlines.
        // We need to normalize whitespace/HTML for comparison, or assert containment.
        // For now, simple trim comparison.
        
        // Note: Our render_bibliography output might be plain text or contain Markdown/HTML depending on renderer.
        // Processor::render_bibliography() uses PlainText by default.
        // CSL test suite results often look like:
        // <div class="csl-bib-body">
        //   <div class="csl-entry">...</div>
        // </div>
        // If the expected result contains HTML, we might fail if we produce PlainText.
        // But many disambiguation tests just check the text content like "2000a" vs "2000b".
        
        // Let's check typical result format in our selected tests.
        // disambiguate_YearSuffixAndSort.txt -> "1990m!; 1990l!..." (It says MODE: citation, so it's citation output)
        
        assert_eq!(actual.trim(), expected.trim(), "Bibliography output mismatch");
    }
}

#[test]
#[ignore]
fn test_disambiguate_yearsuffixandsort() {
    let csl = r####"<style 
      xmlns="http://purl.org/net/xbiblio/csl"
      class="note"
      version="1.0">
  <info>
    <id />
    <title />
    <updated>2009-08-10T04:49:00+09:00</updated>
  </info>
  <macro name="date">
    <date variable="issued">
      <date-part name="year" />
    </date>
    <text suffix="!" variable="year-suffix" />
  </macro>
  <citation 
         disambiguate-add-year-suffix="true">
    <layout delimiter="; ">
      <text macro="date" />
    </layout>
  </citation>
  <bibliography>
    <sort>
      <key variable="issued" />
      <key variable="title" />
    </sort>
    <layout>
      <text value="Ignore me" />
    </layout>
  </bibliography>
</style>"####;
    let input = r####"[{"author": [{"family": "Asthma", "given": "Albert"}, {"family": "Bronchitis", "given": "Bosworth"}, {"family": "Cold", "given": "Crispin"}, {"family": "Dropsy", "given": "David"}, {"family": "Ebola", "given": "Elvin"}, {"family": "Fever", "given": "Fergus"}], "id": "ambigs-1", "issued": {"date-parts": [[1990]]}, "title": "Book M", "type": "book"}, {"author": [{"family": "Asthma", "given": "Albert"}, {"family": "Bronchitis", "given": "Bosworth"}, {"family": "Cold", "given": "Crispin"}, {"family": "Dropsy", "given": "David"}, {"family": "Enteritis", "given": "Ernie"}, {"family": "Fever", "given": "Fergus"}], "id": "ambigs-2", "issued": {"date-parts": [[1990]]}, "title": "Book L", "type": "book"}, {"author": [{"family": "Asthma", "given": "Albert"}, {"family": "Bronchitis", "given": "Bosworth"}, {"family": "Cold", "given": "Crispin"}, {"family": "Dropsy", "given": "David"}, {"family": "Ebola", "given": "Elvin"}, {"family": "Fever", "given": "Fergus"}], "id": "ambigs-3", "issued": {"date-parts": [[1990]]}, "title": "Book K", "type": "book"}, {"author": [{"family": "Asthma", "given": "Albert"}, {"family": "Bronchitis", "given": "Bosworth"}, {"family": "Cold", "given": "Crispin"}], "id": "ambigs-4", "issued": {"date-parts": [[1990]]}, "title": "Book J", "type": "book"}, {"author": [{"family": "Asthma", "given": "Albert"}, {"family": "Bronchitis", "given": "Beauregarde"}, {"family": "Cold", "given": "Crispin"}], "id": "ambigs-5", "issued": {"date-parts": [[1990]]}, "title": "Book I", "type": "book"}, {"author": [{"family": "Asthma", "given": "Alan"}, {"family": "Bronchitis", "given": "Bosworth"}, {"family": "Cold", "given": "Crispin"}, {"family": "Dropsy", "given": "David"}, {"family": "Ebola", "given": "Elvin"}, {"family": "Fever", "given": "Fergus"}], "id": "ambigs-6", "issued": {"date-parts": [[1990]]}, "title": "Book H", "type": "book"}, {"author": [{"family": "Doe", "given": "John"}, {"family": "Roe", "given": "Janet"}], "id": "ambigs-7", "issued": {"date-parts": [[1990]]}, "title": "Book G", "type": "book"}, {"author": [{"family": "Doe", "given": "John"}, {"family": "Roe", "given": "Jane"}], "id": "ambigs-8", "issued": {"date-parts": [[1990]]}, "title": "Book F", "type": "book"}, {"author": [{"family": "Doe", "given": "John"}, {"family": "Roe", "given": "Jane"}], "id": "ambigs-9", "issued": {"date-parts": [[1990]]}, "title": "Book E", "type": "book"}, {"author": [{"family": "Doe", "given": "John"}, {"family": "Roe", "given": "Janet"}], "id": "ambigs-10", "issued": {"date-parts": [[1990]]}, "title": "Book D", "type": "book"}, {"author": [{"family": "Doe", "given": "John"}, {"family": "Roe", "given": "Jane"}, {"family": "Jones", "given": "Robert"}], "id": "ambigs-11", "issued": {"date-parts": [[1990]]}, "title": "Book C", "type": "book"}, {"author": [{"family": "Doe", "given": "John"}, {"family": "Roe", "given": "Josephine"}, {"family": "Jones", "given": "Robert"}], "id": "ambigs-12", "issued": {"date-parts": [[1990]]}, "title": "Book B", "type": "book"}, {"author": [{"family": "Doe", "given": "John"}, {"family": "Roe", "given": "Jane"}, {"family": "Jones", "given": "Richard"}], "id": "ambigs-13", "issued": {"date-parts": [[1990]]}, "title": "Book A", "type": "book"}]"####;
    let citation_items = r####"[[{"id": "ambigs-1"}, {"id": "ambigs-2"}, {"id": "ambigs-3"}, {"id": "ambigs-4"}, {"id": "ambigs-5"}, {"id": "ambigs-6"}, {"id": "ambigs-7"}, {"id": "ambigs-8"}, {"id": "ambigs-9"}, {"id": "ambigs-10"}, {"id": "ambigs-11"}, {"id": "ambigs-12"}, {"id": "ambigs-13"}]]"####;
    let expected = r####"1990m!; 1990l!; 1990k!; 1990j!; 1990i!; 1990h!; 1990g!; 1990f!; 1990e!; 1990d!; 1990c!; 1990b!; 1990a!"####;
    let mode = "citation";

    run_test_case(csl, input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_yearsuffixattwolevels() {
    let csl = r####""####;
    let input = r####"[]"####;
    let citation_items = r####"[]"####;
    let expected = r####""####;
    let mode = "citation";

    run_test_case(csl, input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_yearsuffixmixeddates() {
    let csl = r####"<style xmlns="http://purl.org/net/xbiblio/csl" class="in-text" version="1.0">
  <info>
    <title>The Journal of Neuroscience vJT</title>
    <id>http://www.zotero.org/styles/journal-of-neuroscience-collapsedciteyears</id>
    <link href="http://www.zotero.org/styles/journal-of-neuroscience-collapsedciteyears" rel="self"/>
    <author>
      <name>Ullrich Bartsch</name>
      <email>ubartsch@gmail.com</email>
    </author>
    <contributor>
      <name>Omar Mian</name>
      <email>o.mian@ucl.ac.uk</email>
    </contributor>
    <category citation-format="author-date"/>
    <category field="medicine"/>
    <updated>2011-08-14T18:46:01+00:00</updated>
    <summary>The Journal of Neuroscience style</summary>
    <link href="http://www.jneurosci.org/misc/ifa_organization.shtml" rel="documentation"/>
    <rights>This work is licensed under a Creative Commons Attribution-Share Alike 3.0 License: http://creativecommons.org/licenses/by-sa/3.0/</rights>
  </info>
  <citation disambiguate-add-year-suffix="true" collapse="year-suffix">
    <layout prefix="(" suffix=")" delimiter="; ">
        <group delimiter=", ">
          <names variable="author"/>
          <date variable="issued" form="text" date-parts="year"/>
        </group>
    </layout>
  </citation>
  <bibliography hanging-indent="true" et-al-min="20" et-al-use-first="1">
    <layout suffix=".">
      <text value="forget me"/>
    </layout>
  </bibliography>
</style>"####;
    let input = r####"[{"author": [{"family": "Ylinen", "given": "A"}], "id": 22, "issued": {"date-parts": [[1995]]}, "type": "article-journal"}, {"author": [{"family": "Ylinen", "given": "A"}], "id": 21, "issued": {"date-parts": [[1995]]}, "type": "article-journal"}, {"author": [{"family": "Ylinen", "given": "A"}], "id": 23, "issued": {"date-parts": [[1995]]}, "type": "article-journal"}]"####;
    let citation_items = r####"[]"####;
    let expected = r####"(A Ylinen, 1995a; b; c)"####;
    let mode = "citation";

    run_test_case(csl, input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_bycitetwoauthorssamefamilyname() {
    let csl = r####"<style 
      xmlns="http://purl.org/net/xbiblio/csl"
      class="note"
      version="1.0">
  <info>
    <id />
    <title />
    <updated>2009-08-10T04:49:00+09:00</updated>
  </info>
  <citation 
         disambiguate-add-givenname="true"
         disambiguate-add-year-suffix="true"
         givenname-disambiguation-rule="by-cite">
    <layout delimiter="; ">
      <names delimiter=", " variable="author">
        <name and="text" delimiter=", " delimiter-precedes-last="never" form="short" initialize-with="." />
      </names>
      <group prefix=" (" suffix=")">
        <date variable="issued">
          <date-part name="year" />
        </date>
        <text variable="year-suffix" />
      </group>
    </layout>
  </citation>
</style>"####;
    let input = r####"[{"author": [{"family": "Asthma", "given": "Albert"}, {"family": "Asthma", "given": "Bridget"}], "id": "ITEM-1", "issued": {"date-parts": [[1980]]}, "title": "Book A", "type": "book"}, {"author": [{"family": "Bronchitis", "given": "Beauregarde"}], "id": "ITEM-2", "issued": {"date-parts": [[1995]]}, "title": "Book B", "type": "book"}, {"author": [{"family": "Asthma", "given": "Albert"}], "id": "ITEM-3", "issued": {"date-parts": [[1885]]}, "title": "Book C", "type": "book"}]"####;
    let citation_items = r####"[]"####;
    let expected = r####"Asthma and Asthma (1980); Bronchitis (1995); Asthma (1885)"####;
    let mode = "citation";

    run_test_case(csl, input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_addnamessuccess() {
    let csl = r####"<style 
      xmlns="http://purl.org/net/xbiblio/csl"
      class="note"
      version="1.0">
  <info>
    <id />
    <title />
    <updated>2009-08-10T04:49:00+09:00</updated>
  </info>
  <citation 
         et-al-min="3"
         et-al-use-first="1"
         disambiguate-add-names="true">
    <layout delimiter="; ">
      <group delimiter=" ">
        <names delimiter=", " variable="author">
          <name and="symbol" delimiter-precedes-last="never" form="short"/>
        </names>
        <date variable="issued" prefix="(" suffix=")">
          <date-part name="year"/>
        </date>
      </group>
    </layout>
  </citation>
</style>"####;
    let input = r####"[{"author": [{"family": "Smith", "given": "John"}, {"family": "Brown", "given": "John"}, {"family": "Jones", "given": "John"}], "id": "ITEM-1", "issued": {"date-parts": [[1980]]}, "type": "book"}, {"author": [{"family": "Smith", "given": "John"}, {"family": "Beefheart", "given": "Captain"}, {"family": "Jones", "given": "John"}], "id": "ITEM-2", "issued": {"date-parts": [[1980]]}, "type": "book"}]"####;
    let citation_items = r####"[]"####;
    let expected = r####"Smith, Brown, et al. (1980); Smith, Beefheart, et al. (1980)"####;
    let mode = "citation";

    run_test_case(csl, input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_addnamesfailure() {
    let csl = r####"<style 
      xmlns="http://purl.org/net/xbiblio/csl"
      class="note"
      version="1.0">
  <info>
    <id />
    <title />
    <updated>2009-08-10T04:49:00+09:00</updated>
  </info>
  <citation 
         et-al-min="3"
         et-al-use-first="1"
         disambiguate-add-names="true">
    <layout delimiter="; ">
      <group delimiter=" ">
        <names delimiter=", " variable="author">
          <name and="symbol" delimiter-precedes-last="never" form="short"/>
        </names>
        <date variable="issued" prefix="(" suffix=")">
          <date-part name="year"/>
        </date>
      </group>
    </layout>
  </citation>
</style>"####;
    let input = r####"[{"author": [{"family": "Smith", "given": "John"}, {"family": "Brown", "given": "John"}, {"family": "Jones", "given": "John"}], "id": "ITEM-1", "issued": {"date-parts": [[1980]]}, "type": "book"}, {"author": [{"family": "Smith", "given": "John"}, {"family": "Brown", "given": "John"}, {"family": "Jones", "given": "John"}], "id": "ITEM-2", "issued": {"date-parts": [[1980]]}, "type": "book"}]"####;
    let citation_items = r####"[]"####;
    let expected = r####"Smith et al. (1980); Smith et al. (1980)"####;
    let mode = "citation";

    run_test_case(csl, input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_bycitegivennameshortforminitializewith() {
    let csl = r####"<style 
      xmlns="http://purl.org/net/xbiblio/csl"
      class="note"
      version="1.0">
  <info>
    <id />
    <title />
    <updated>2009-08-10T04:49:00+09:00</updated>
  </info>
  <citation 
         disambiguate-add-givenname="true"
         givenname-disambiguation-rule="by-cite">
    <layout delimiter="; ">
      <names variable="author">
        <name form="short" initialize-with="" />
      </names>
    </layout>
  </citation>
</style>"####;
    let input = r####"[{"author": [{"family": "Roe", "given": "Jane"}], "id": "ITEM-1", "type": "book"}, {"author": [{"family": "Doe", "given": "John"}], "id": "ITEM-2", "type": "book"}, {"author": [{"family": "Doe", "given": "Aloysius"}], "id": "ITEM-3", "type": "book"}, {"author": [{"family": "Smith", "given": "Thomas"}], "id": "ITEM-4", "type": "book"}, {"author": [{"family": "Smith", "given": "Ted"}], "id": "ITEM-5", "type": "book"}]"####;
    let citation_items = r####"[[{"id": "ITEM-1"}], [{"id": "ITEM-2"}, {"id": "ITEM-3"}], [{"id": "ITEM-4"}, {"id": "ITEM-5"}]]"####;
    let expected = r####"Roe
J Doe; A Doe
Thomas Smith; Ted Smith"####;
    let mode = "citation";

    run_test_case(csl, input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_basedonetalsubsequent() {
    let csl = r####"<style 
      xmlns="http://purl.org/net/xbiblio/csl"
      class="note"
      version="1.0">
  <info>
    <id />
    <title />
    <updated>2009-08-10T04:49:00+09:00</updated>
  </info>
  <citation 
         disambiguate-add-year-suffix="true"
         et-al-min="3"
         et-al-subsequent-min="1"
         et-al-subsequent-use-first="1"
         et-al-use-first="3">
    <layout delimiter="; " prefix="(" suffix=")">
      <names variable="author">
        <name and="symbol" delimiter=", " delimiter-precedes-last="never" form="short" />
      </names>
      <date prefix=" " variable="issued">
        <date-part name="year" />
      </date>
      <text font-style="italic" variable="year-suffix" />
    </layout>
  </citation>
</style>"####;
    let input = r####"[{"author": [{"family": "Baur", "given": "Bruno"}, {"family": "Fr\u00f6berg", "given": "Lars"}, {"family": "Baur", "given": "Anette"}, {"family": "Guggenheim", "given": "Richard"}, {"family": "Haase", "given": "Martin"}], "container-title": "Nordic Journal of Botany", "id": "ITEM-1", "issued": {"date-parts": [[2000]]}, "page": "119-128", "title": "Ultrastructure of snail grazing damage to calcicolous lichens", "type": "article-journal", "volume": "20"}, {"author": [{"family": "Baur", "given": "Bruno"}, {"family": "Schileyko", "given": "Anatoly A."}, {"family": "Baur", "given": "Anette"}], "container-title": "Journal of Molluscan Studies", "id": "ITEM-2", "issued": {"date-parts": [[2000]]}, "page": "285-289", "title": "Ecological observations on _Arianta aethiops aethiops_ (Helicidae), a land snail endemic to the South Carpathian mountains, Romania", "type": "article-journal", "volume": "66"}, {"author": [{"family": "Doe", "given": "John"}], "container-title": "Journal of Irreproducible Results", "id": "ITEM-3", "issued": {"date-parts": [[2000]]}, "page": "5-7", "title": "Some bogus title", "type": "article-journal", "volume": "666"}]"####;
    let citation_items = r####"[]"####;
    let expected = r####"(Baur, Fröberg, Baur, et al. 2000<i>a</i>; Baur, Schileyko &#38; Baur 2000<i>b</i>; Doe 2000)"####;
    let mode = "citation";

    run_test_case(csl, input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_bycitedisambiguatecondition() {
    let csl = r####"<style 
      xmlns="http://purl.org/net/xbiblio/csl"
      class="note"
      version="1.0">
  <info>
    <id />
    <title />
    <updated>2009-08-10T04:49:00+09:00</updated>
  </info>
  <citation 
         disambiguate-add-givenname="true"
         disambiguate-add-names="true"
         et-al-min="2"
         et-al-use-first="1"
         givenname-disambiguation-rule="by-cite">
    <layout delimiter="; ">
      <group delimiter=", ">
        <names variable="author">
          <name and="symbol" delimiter=", " form="short" />
        </names>
        <choose>
          <if disambiguate="true">
            <text font-style="italic" variable="title" />
          </if>
        </choose>
      </group>
      <group prefix=" (" suffix=")">
        <date variable="issued">
          <date-part name="year" />
        </date>
      </group>
    </layout>
  </citation>
</style>"####;
    let input = r####"[{"author": [{"family": "Doe", "given": "John"}, {"family": "Roe", "given": "Jane"}], "id": "ITEM-1", "issued": {"date-parts": [[2000]]}, "title": "Book A", "type": "book"}, {"author": [{"family": "Doe", "given": "John"}, {"family": "Roe", "given": "Jane"}], "id": "ITEM-2", "issued": {"date-parts": [[2000]]}, "title": "Book B", "type": "book"}]"####;
    let citation_items = r####"[]"####;
    let expected = r####"Doe et al., <i>Book A</i> (2000); Doe et al., <i>Book B</i> (2000)"####;
    let mode = "citation";

    run_test_case(csl, input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_failwithyearsuffix() {
    let csl = r####""####;
    let input = r####"[]"####;
    let citation_items = r####"[]"####;
    let expected = r####""####;
    let mode = "citation";

    run_test_case(csl, input, citation_items, expected, mode);
}

#[test]
#[ignore]
fn test_disambiguate_yearsuffixfiftytwoentries() {
    let csl = r####"<style 
      xmlns="http://purl.org/net/xbiblio/csl"
      class="note"
      version="1.0">
  <info>
    <id />
    <title />
    <updated>2009-08-10T04:49:00+09:00</updated>
  </info>
  <citation 
         et-al-min="3"
         et-al-use-first="1"
         disambiguate-add-names="true"
         disambiguate-add-givenname="true"
         disambiguate-add-year-suffix="true"
         givenname-disambiguation-rule="all-names">
    <layout delimiter="; " prefix="(" suffix=")">
      <group delimiter=" ">
        <names delimiter=", " variable="author">
          <name and="symbol" delimiter-precedes-last="never" form="short"/>
        </names>
        <date variable="issued">
          <date-part name="year"/>
        </date>
      </group>
    </layout>
  </citation>
</style>"####;
    let input = r####"[{"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-1"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-2"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-3"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-4"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-5"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-6"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-7"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-8"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-9"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-10"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-11"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-12"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-13"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-14"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-15"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-16"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-17"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-18"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-19"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-20"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-21"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-22"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-23"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-24"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-25"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-26"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-27"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-28"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-29"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-30"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-31"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-32"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-33"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-34"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-35"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-36"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-37"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-38"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-39"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-40"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-41"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-42"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-43"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-44"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-45"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-46"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-47"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-48"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-49"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-50"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-51"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-52"}, {"author": [{"family": "Smith", "given": "John"}], "issued": {"date-parts": [[1986]]}, "type": "book", "id": "ITEM-53"}]"####;
    let citation_items = r####"[]"####;
    let expected = r####"..[0] (Smith 1986a; Smith 1986b; Smith 1986c; Smith 1986d; Smith 1986e; Smith 1986f; Smith 1986g; Smith 1986h; Smith 1986i; Smith 1986j; Smith 1986k; Smith 1986l; Smith 1986m; Smith 1986n; Smith 1986o; Smith 1986p; Smith 1986q; Smith 1986r; Smith 1986s; Smith 1986t; Smith 1986u; Smith 1986v; Smith 1986w; Smith 1986x; Smith 1986y; Smith 1986z; Smith 1986aa; Smith 1986ab; Smith 1986ac; Smith 1986ad; Smith 1986ae; Smith 1986af; Smith 1986ag; Smith 1986ah; Smith 1986ai; Smith 1986aj; Smith 1986ak; Smith 1986al; Smith 1986am; Smith 1986an; Smith 1986ao; Smith 1986ap; Smith 1986aq; Smith 1986ar; Smith 1986as; Smith 1986at; Smith 1986au; Smith 1986av; Smith 1986aw; Smith 1986ax; Smith 1986ay)
>>[1] (Smith 1986az)"####;
    let mode = "citation";

    run_test_case(csl, input, citation_items, expected, mode);
}
